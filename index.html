<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weavers Wild Runs</title>
<style>
/* ===================================================================== */
/* BASIC PAGE SETUP                                                      */
/* ===================================================================== */
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
    height: 100vh;
    font-family: 'Courier New', monospace;
    color: #ff0066;
}

/* ===================================================================== */
/* UNIVERSE BACKGROUND - STARS ALWAYS VISIBLE                            */
/* ===================================================================== */
#universe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    background: radial-gradient(circle at center, #0a0020 0%, #000000 70%);
}
.star {
    position: absolute;
    background: #ffffff;
    border-radius: 50%;
    opacity: 0.8;
    animation: twinkle linear infinite;
}
@keyframes twinkle {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
}

canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
}

/* ===================================================================== */
/* HOLOGRAPHIC LOGO - FIXED: NO MORE SNAP ON LOOP                        */
/* Now uses pure CSS keyframes for the gentle tilt ‚Üí perfectly smooth    */
/* infinite loop with ease-in-out. No JS transform = no snap/jitter.     */
/* Shine + glare still move smoothly via JS.                             */
/* ===================================================================== */
#logo-container {
    position: fixed;
    top: 15vh;                  /* Move logo higher/lower here */
    left: 50%;
    transform: translateX(-50%);
    perspective: 1200px;
    width: 380px;               /* Mobile size - tweak if needed */
    height: 380px;
    z-index: 90;
    pointer-events: none;
}
@media (min-width: 768px) {
    #logo-container {
        width: 560px;           /* Desktop size */
        height: 560px;
        top: 12vh;
    }
}
#logo-card {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    animation: idleLogo 24s infinite ease-in-out;  /* Slow gentle float - no snap ever */
}
@keyframes idleLogo {
    0%, 100% { transform: rotateY(0deg) rotateX(0deg); }
    25% { transform: rotateY(10deg) rotateX(-8deg); }
    50% { transform: rotateY(-12deg) rotateX(6deg); }
    75% { transform: rotateY(8deg) rotateX(-10deg); }
}
.holo-logo {
    width: 100%;
    height: 100%;
    position: relative;
    background: url('wwr.png') center / contain no-repeat;  /* ‚Üê YOUR LOGO PNG HERE */
}
.effect-mask {
    position: absolute;
    inset: 0;
    -webkit-mask: url('wwr.png') center / contain no-repeat;
    mask: url('wwr.png') center / contain no-repeat;
    pointer-events: none;
}
.foil-shine {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg,
        #ff00ff 0%,
        #00ffff 25%,
        #ffff00 50%,
        #00ff00 75%,
        #ff00ff 100%
    );
    background-size: 300% 300%;
    mix-blend-mode: overlay;
    opacity: 0.7;
}
.foil-glare {
    position: absolute;
    inset: 0;
    background: linear-gradient(45deg,
        transparent 40%,
        rgba(255,255,255,0.5) 50%,
        transparent 60%
    );
    background-size: 200% 200%;
    mix-blend-mode: color-dodge;
    opacity: 0.8;
}
.grain {
    position: absolute;
    inset: 0;
    background: url('https://assets.codepen.io/13471/sparkles.gif') repeat;
    background-size: 200px 200px;
    mix-blend-mode: soft-light;
    opacity: 0.5;
}

/* Rest of styles unchanged */
#loader {
    position: fixed;
    top: 12px;
    right: 12px;
    left: auto;
    max-width: 200px;
    width: fit-content;
    min-width: 160px;
    padding: 8px 12px;
    background: #000;
    border: 3px ridge #00ff00;
    border-radius: 8px;
    box-shadow:
        0 0 15px #00ff0033,
        inset 0 0 10px rgba(0, 255, 0, 0.15);
    z-index: 101;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: nowrap;
    box-sizing: border-box;
    overflow: hidden;
    font-family: 'Courier New', 'Lucida Console', monospace;
    font-weight: bold;
}
#loader::before {
    content: '';
    position: absolute;
    inset: 3px;
    background: linear-gradient(
        rgba(0, 30, 0, 0.5) 50%,
        rgba(0, 50, 0, 0.5) 50%
    );
    background-size: 100% 3px;
    border-radius: 5px;
    pointer-events: none;
}
#loader, #playBtn, #uploadBtn, #disc, #trackContainer {
    color: #00ff00;
    text-shadow:
        0 0 4px #00ff00,
        0 0 8px #00ff00;
    z-index: 2;
}
#playBtn, #uploadBtn, #disc {
    font-size: 1.4em;
    cursor: pointer;
    user-select: none;
    flex-shrink: 0;
}
#disc {
    display: none;
    animation: spin 2s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
#trackContainer {
    flex: 1;
    min-width: 80px;
    height: 20px;
    overflow: hidden;
    position: relative;
}
#trackName {
    font-size: 0.75em;
    white-space: nowrap;
    display: inline-block;
    padding-left: 100%;
    animation: scroll-left 10s linear infinite;
}
@keyframes scroll-left {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}
#trackContainer:hover #trackName {
    animation-play-state: paused;
}
#loader.loaded { border-color: #00ff00; }
#loader.failed {
    border-color: #ff0000;
    color: #ff0000;
    text-shadow: 0 0 8px #ff0000;
}
input[type="file"] { display: none; }

/* BUTTONS */
.button-container-mobile {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    gap: 80px;
    z-index: 100;
    justify-content: center;
}
.button-container-left, .button-container-right {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 120px;
    z-index: 100;
}
.button-container-left { left: 12vw; }
.button-container-right { right: 12vw; }
.button-container-left, .button-container-right, .button-container-mobile { display: none; }
@media (max-width: 767px) { .button-container-mobile { display: flex; } }
@media (min-width: 768px) { .button-container-left, .button-container-right { display: flex; } }

.jar {
    width: 240px;
    height: 100px;
    position: relative;
    cursor: grab;
    user-select: none;
    transform-style: preserve-3d;
    animation: idleJarMobile 14s infinite ease-in-out;
    will-change: transform;
    z-index: 100;
    border-radius: 60px;
    overflow: hidden;
    background: rgba(20, 30, 50, 0.4);
    backdrop-filter: blur(14px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), inset 0 0 50px rgba(100, 150, 100, 0.15);
    border: 2.5px solid #0a3d2a;
}
@media (min-width: 768px) {
    .jar {
        width: 360px;
        height: 140px;
        animation: idleJarDesktop 16s infinite ease-in-out;
    }
}
.jar:active { cursor: grabbing; }
.jar::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 60px;
    padding: 3px;
    background: linear-gradient(45deg, rgba(100, 255, 100, 0.25), rgba(255, 255, 100, 0.2), rgba(100, 200, 255, 0.15));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0.5;
}
.inner-glow {
    position: absolute;
    inset: 15px;
    border-radius: 50px;
    background: radial-gradient(circle at 40% 40%, rgba(150, 255, 100, 0.12), transparent 70%);
    pointer-events: none;
}
.contents {
    position: absolute;
    inset: 0;
    pointer-events: none;
}
.letter {
    position: absolute;
    color: #ffffff;
    font-size: 32px;
    font-weight: bold;
    text-transform: uppercase;
    text-shadow:
        0 0 8px #ffffff,
        0 0 16px #ccff99,
        0 0 24px #99ff99,
        0 0 32px #66ff66,
        0 0 40px #33ff33;
    -webkit-text-stroke: 2px #0a3d2a;
    text-stroke: 2px #0a3d2a;
    pointer-events: none;
    will-change: left, top;
}
@media (min-width: 768px) { .letter { font-size: 42px; } }
.firefly {
    position: absolute;
    width: 10px;
    height: 10px;
    background: radial-gradient(circle, #e0ffaa, transparent 70%);
    border-radius: 50%;
    box-shadow: 0 0 20px 4px #ccff99;
    pointer-events: none;
}
@keyframes idleJarMobile {
    0%, 100% { transform: perspective(1200px) rotateX(0deg) rotateY(0deg); }
    25% { transform: perspective(1200px) rotateX(-2deg) rotateY(4deg); }
    50% { transform: perspective(1200px) rotateX(1.5deg) rotateY(-3deg); }
    75% { transform: perspective(1200px) rotateX(-1.5deg) rotateY(-2.5deg); }
}
@keyframes idleJarDesktop {
    0%, 100% { transform: perspective(1600px) rotateX(0deg) rotateY(0deg); }
    25% { transform: perspective(1600px) rotateX(-4deg) rotateY(7deg); }
    50% { transform: perspective(1600px) rotateX(3deg) rotateY(-5deg); }
    75% { transform: perspective(1600px) rotateX(-3deg) rotateY(-6deg); }
}
</style>
</head>
<body>

<!-- UNIVERSE BACKGROUND -->
<div id="universe"></div>

<!-- HOLOGRAPHIC LOGO (NOW SUPER SMOOTH - NO SNAP) -->
<div id="logo-container">
    <div class="card" id="logo-card">
        <div class="holo-logo">
            <div class="effect-mask">
                <div class="foil-shine" id="shine"></div>
                <div class="foil-glare" id="glare"></div>
                <div class="grain"></div>
            </div>
        </div>
    </div>
</div>

<!-- VISUALIZER CANVAS -->
<canvas id="canvas"></canvas>

<!-- MP3 PLAYER -->
<div id="loader">
    <span id="playBtn">‚ñ∂Ô∏é</span>
    <span id="disc">üíø</span>
    <span id="uploadBtn">üìÇ</span>
    <div id="trackContainer">
        <div id="trackName">Wild-Runs.mp3</div>
    </div>
</div>
<input type="file" id="fileInput" accept="audio/mp3,audio/mpeg">
<audio id="audio" preload="auto"></audio>

<!-- BUTTONS -->
<div class="button-container-mobile">
  <div class="jar" data-text="Instagram" data-link="https://www.instagram.com/weaverswildruns?igsh=b2hrbjRtNzhwNDk3">
    <div class="inner-glow"></div>
    <div class="contents"></div>
  </div>
  <div class="jar" data-text="Donate" data-link="https://www.justgiving.com/page/weaverswildruns?utm_medium=FR&utm_source=WA&utm_content=link_in_bio&fbclid=PAZXh0bgNhZW0CMTEAc3J0YwZhcHBfaWQMMjU2MjgxMDQwNTU4AAGnl8qTqb0Sy0FzCnqqgprC_uvBsz1MgaWj5bVxHCV6pPAAgkKRHlDFPFjTUO0_aem_lW1GCJmN78eQvX6fdaaigQ">
    <div class="inner-glow"></div>
    <div class="contents"></div>
  </div>
  <div class="jar" data-text="Strava" data-link="https://www.strava.com/athletes/20154088">
    <div class="inner-glow"></div>
    <div class="contents"></div>
  </div>
</div>

<div class="button-container-left">
  <div class="jar" data-text="Instagram" data-link="https://www.instagram.com/weaverswildruns?igsh=b2hrbjRtNzhwNDk3">
    <div class="inner-glow"></div>
    <div class="contents"></div>
  </div>
  <div class="jar" data-text="Strava" data-link="https://www.strava.com/athletes/20154088">
    <div class="inner-glow"></div>
    <div class="contents"></div>
  </div>
</div>

<div class="button-container-right">
  <div class="jar" data-text="Donate" data-link="https://www.justgiving.com/page/weaverswildruns?utm_medium=FR&utm_source=WA&utm_content=link_in_bio&fbclid=PAZXh0bgNhZW0CMTEAc3J0YwZhcHBfaWQMMjU2MjgxMDQwNTU4AAGnl8qTqb0Sy0FzCnqqgprC_uvBsz1MgaWj5bVxHCV6pPAAgkKRHlDFPFjTUO0_aem_lW1GCJmN78eQvX6fdaaigQ">
    <div class="inner-glow"></div>
    <div class="contents"></div>
  </div>
</div>

<script>
// VISUALIZER + AUDIO (no fade - stars stay visible)
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const audio = document.getElementById('audio');
const loader = document.getElementById('loader');
const playBtn = document.getElementById('playBtn');
const disc = document.getElementById('disc');
const uploadBtn = document.getElementById('uploadBtn');
const trackName = document.getElementById('trackName');
const fileInput = document.getElementById('fileInput');

let audioCtx, analyser, source, dataArray, bufferLength;
let started = false;
let particles = [];

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

audio.src = "Wild-Runs.mp3";
audio.load();
trackName.textContent = "Wild-Runs.mp3";

audio.addEventListener('canplaythrough', () => loader.classList.add('loaded'));
audio.addEventListener('error', () => {
    loader.classList.add('failed');
    trackName.textContent = "Failed to load";
});

function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    source = audioCtx.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function animate() {
    requestAnimationFrame(animate);

    if (analyser) {
        analyser.getByteFrequencyData(dataArray);
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        let bassSum = 0;
        for (let i = 0; i < 40; i++) bassSum += dataArray[i];
        const bass = bassSum / (40 * 255);
        const pulse = 80 + bass * 450;

        const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, pulse);
        grad.addColorStop(0, 'rgba(255,0,102,1)');
        grad.addColorStop(0.4, 'rgba(255,0,102,0.5)');
        grad.addColorStop(1, 'rgba(0,255,255,0)');
        ctx.fillStyle = grad;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.arc(cx, cy, pulse, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1.0;

        const bars = 128;
        for (let i = 0; i < bars; i++) {
            const angle = i / bars * Math.PI * 2;
            const idx = Math.floor(i / bars * bufferLength);
            const h = (dataArray[idx] / 255) * 600 + bass * 300;
            const r = 140 + bass * 120;
            ctx.strokeStyle = `rgba(255,0,102,${0.4 + bass * 0.6})`;
            ctx.lineWidth = 6 + bass * 12;
            ctx.shadowBlur = 40 + bass * 60;
            ctx.shadowColor = '#ff0066';
            ctx.beginPath();
            ctx.moveTo(cx + Math.cos(angle) * r, cy + Math.sin(angle) * r);
            ctx.lineTo(cx + Math.cos(angle) * (r + h), cy + Math.sin(angle) * (r + h));
            ctx.stroke();
        }

        if (bass > 0.65 && Math.random() > 0.3) {
            for (let i = 0; i < 10; i++) {
                const a = Math.random() * Math.PI * 2;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(a) * (20 + bass * 50),
                    vy: Math.sin(a) * (20 + bass * 50),
                    life: 45,
                    color: i % 2 ? '#00ffff' : '#ff0066'
                });
            }
        }
    }

    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 1.8;
        ctx.strokeStyle = p.color;
        ctx.globalAlpha = p.life / 45;
        ctx.lineWidth = p.life / 7;
        ctx.shadowBlur = 25;
        ctx.shadowColor = p.color;
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, canvas.height / 2);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
    });
    ctx.globalAlpha = 1.0;
    ctx.shadowBlur = 0;
}
animate();

playBtn.addEventListener('click', () => {
    if (!started) {
        initAudio();
        started = true;
    }
    if (audio.paused) {
        audio.play().catch(() => {
            loader.classList.add('failed');
            trackName.textContent = "Playback blocked";
        });
    } else {
        audio.pause();
    }
});
audio.addEventListener('play', () => {
    playBtn.textContent = "‚ùö‚ùö";
    disc.style.display = "inline";
});
audio.addEventListener('pause', () => {
    playBtn.textContent = "‚ñ∂Ô∏é";
    disc.style.display = "none";
});

uploadBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file && file.type === 'audio/mpeg') {
        audio.src = URL.createObjectURL(file);
        trackName.textContent = file.name;
        loader.classList.remove('failed');
        loader.classList.add('loaded');
        trackName.style.animation = 'none';
        trackName.offsetHeight;
        trackName.style.animation = 'scroll-left 10s linear infinite';
    }
});

// UNIVERSE STARS
const universe = document.getElementById('universe');
const starCount = 400;

function createStars() {
    universe.innerHTML = '';
    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = Math.random() * 3 + 1;
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        const duration = Math.random() * 40 + 20;
        const delay = Math.random() * 10;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${x}vw`;
        star.style.top = `${y}vh`;
        star.style.animationDuration = `${duration}s`;
        star.style.animationDelay = `${delay}s`;
        if (Math.random() > 0.9) {
            star.style.boxShadow = '0 0 10px #ffffff';
            star.style.opacity = '1';
        }
        universe.appendChild(star);
    }
}
createStars();
window.addEventListener('resize', createStars);

// HOLOGRAPHIC LOGO - ONLY SHINE + GLARE (TILT IS NOW CSS - SUPER SMOOTH)
const shine = document.getElementById('shine');
const glare = document.getElementById('glare');

function animateLogo() {
    const time = performance.now() / 1000;
    // Slower, more dreamy shine cycle (full circle ~8 seconds)
    const angle1 = (time / 8) % (Math.PI * 2);
    const radius1 = 48;
    const posX1 = 50 + Math.sin(angle1) * radius1;
    const posY1 = 50 + Math.cos(angle1) * radius1;
    shine.style.backgroundPosition = `${posX1}% ${posY1}%`;

    // Slower glare cycle (~6 seconds)
    const angle2 = (time / 6) % (Math.PI * 2);
    const radius2 = 45;
    const posX2 = 50 + Math.sin(angle2 + 1) * radius2;
    const posY2 = 50 + Math.cos(angle2 + 1) * radius2;
    glare.style.backgroundPosition = `${posX2}% ${posY2}%`;

    requestAnimationFrame(animateLogo);
}
animateLogo();

// BUTTON SCRIPT (unchanged)
const jars = document.querySelectorAll('.jar');
const DRAG_THRESHOLD = 8;
const MAX_DRAG_DISTANCE = 70;
const k = 0.12;
const friction = 0.94;
const LONG_PRESS_DURATION = 1000;

function initJar(jar) {
  const text = jar.dataset.text;
  const link = jar.dataset.link;
  const contents = jar.querySelector('.contents');
  contents.innerHTML = '';
  const letters = [];
  const letterData = [];
  const fireflies = [];
  const fireflyData = [];
  void jar.offsetWidth;
  const jarW = jar.clientWidth;
  const jarH = jar.clientHeight;
  const centerX = jarW / 2;
  const centerY = jarH / 2;
  const spacing = jarW >= 360 ? 32 : 22;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const span = document.createElement('div');
    span.className = 'letter';
    span.textContent = char;
    contents.appendChild(span);
    const baseX = centerX + (i - (text.length - 1) / 2) * spacing;
    span.style.left = `${baseX}px`;
    span.style.top = `${centerY}px`;
    span.style.transform = 'translate(-50%, -50%)';
    letterData.push({
      el: span,
      baseX,
      baseY: centerY,
      currentX: baseX,
      currentY: centerY,
      vx: 0,
      vy: 0
    });
  }

  const flyCount = jarW >= 360 ? 12 : 8;
  for (let i = 0; i < flyCount; i++) {
    const fly = document.createElement('div');
    fly.className = 'firefly';
    contents.appendChild(fly);
    const x = Math.random() * (jarW - 40) + 20;
    const y = Math.random() * (jarH - 40) + 20;
    fireflyData.push({
      el: fly,
      x,
      y,
      vx: (Math.random() - 0.5) * 1.5,
      vy: (Math.random() - 0.5) * 1.5,
      wanderPhaseX: Math.random() * Math.PI * 2,
      wanderPhaseY: Math.random() * Math.PI * 2,
      wanderSpeedX: 0.004 + Math.random() * 0.006,
      wanderSpeedY: 0.005 + Math.random() * 0.007,
      pulsePhase: Math.random() * Math.PI * 2,
      baseGlow: 0.7 + Math.random() * 0.3,
      sizePhase: Math.random() * Math.PI * 2,
      sizeBase: 0.8 + Math.random() * 0.5
    });
    fly.style.left = `${x}px`;
    fly.style.top = `${y}px`;
  }

  let isDragging = false;
  let startX = 0, startY = 0;
  let currentPullX = 0, currentPullY = 0;
  let velX = 0, velY = 0;
  let pressTimer = null;
  let pressStartTime = 0;
  let isSpringingBack = false;

  const updateJar = (pullX, pullY, shakeIntensity) => {
    const dist = Math.hypot(pullX, pullY);
    const intensity = Math.min(dist / MAX_DRAG_DISTANCE, 1);
    const anchorX = pullX * 0.7;
    const anchorY = pullY * 0.7;
    jar.style.transform = `perspective(1200px)
                           translateX(${anchorX}px)
                           translateY(${anchorY}px)
                           translateZ(${20 + dist / 5}px)
                           rotateX(${-pullY * 0.12}deg)
                           rotateY(${pullX * 0.18}deg)`;

    const force = intensity * shakeIntensity * 1.0;

    letterData.forEach(l => {
      if (isDragging) {
        l.vx += (Math.random() - 0.5) * force * 2.8;
        l.vy += (Math.random() - 0.5) * force * 2.8 - 0.4;
      }
      l.vx *= 0.88;
      l.vy *= 0.88;
      l.currentX += l.vx;
      l.currentY += l.vy;
      l.currentX += (l.baseX - l.currentX) * 0.025;
      l.currentY += (l.baseY - l.currentY) * 0.025;
      l.currentX = Math.max(30, Math.min(jarW - 30, l.currentX));
      l.currentY = Math.max(20, Math.min(jarH - 20, l.currentY));
      l.el.style.left = `${l.currentX}px`;
      l.el.style.top = `${l.currentY}px`;
    });

    const time = Date.now() / 1000;
    fireflyData.forEach(f => {
      f.wanderPhaseX += f.wanderSpeedX;
      f.wanderPhaseY += f.wanderSpeedY;
      const wanderX = Math.sin(f.wanderPhaseX) * 1.2;
      const wanderY = Math.cos(f.wanderPhaseY) * 1.0;
      if (isDragging) {
        f.vx += (Math.random() - 0.5) * force * 3 + pullX * 0.02;
        f.vy += (Math.random() - 0.5) * force * 3 + pullY * 0.02;
      }
      f.vx = f.vx * 0.92 + wanderX * 0.08;
      f.vy = f.vy * 0.92 + wanderY * 0.08;
      f.x += f.vx;
      f.y += f.vy;
      f.x = Math.max(10, Math.min(jarW - 10, f.x));
      f.y = Math.max(10, Math.min(jarH - 10, f.y));
      const pulse = 0.8 + Math.sin(time * 2 + f.pulsePhase) * 0.4;
      const sizePulse = f.sizeBase + Math.sin(time * 1.5 + f.sizePhase) * 0.3;
      f.el.style.left = `${f.x}px`;
      f.el.style.top = `${f.y}px`;
      f.el.style.transform = `scale(${sizePulse})`;
      f.el.style.opacity = f.baseGlow * pulse;
      f.el.style.boxShadow = `0 0 ${25 * pulse}px 6px #ccff99`;
    });
  };

  const resetJar = () => {
    jar.style.animation = window.innerWidth >= 768 ? 'idleJarDesktop 16s infinite ease-in-out' : 'idleJarMobile 14s infinite ease-in-out';
    jar.style.transform = '';
    jar.style.zIndex = '100';
    isSpringingBack = false;
  };

  const startInteraction = (clientX, clientY) => {
    startX = clientX;
    startY = clientY;
    jar.style.animation = 'none';
    jar.style.zIndex = '999';
    isDragging = false;
    currentPullX = 0;
    currentPullY = 0;
    pressStartTime = Date.now();
    pressTimer = setTimeout(() => {
      isDragging = true;
    }, LONG_PRESS_DURATION);
  };

  const moveInteraction = (clientX, clientY) => {
    if (pressTimer === null && !isDragging) return;
    const deltaX = clientX - startX;
    const deltaY = clientY - startY;
    const moved = Math.hypot(deltaX, deltaY);
    if (isDragging || moved > DRAG_THRESHOLD) {
      clearTimeout(pressTimer);
      pressTimer = null;
      isDragging = true;
      let limitedX = deltaX;
      let limitedY = deltaY;
      const dist = Math.hypot(limitedX, limitedY);
      if (dist > MAX_DRAG_DISTANCE) {
        const angle = Math.atan2(limitedY, limitedX);
        limitedX = Math.cos(angle) * MAX_DRAG_DISTANCE;
        limitedY = Math.sin(angle) * MAX_DRAG_DISTANCE;
      }
      currentPullX = limitedX;
      currentPullY = limitedY;
      const shake = dist / 12;
      updateJar(currentPullX, currentPullY, shake);
    } else {
      updateJar(0, 0, 0);
    }
  };

  const endInteraction = () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
      const duration = Date.now() - pressStartTime;
      if (duration < LONG_PRESS_DURATION) {
        window.open(link, '_blank');
      }
    }
    if (isDragging) {
      isDragging = false;
      isSpringingBack = true;
      const animate = () => {
        velX += -currentPullX * k;
        velY += -currentPullY * k;
        velX *= friction;
        velY *= friction;
        currentPullX += velX;
        currentPullY += velY;
        const dist = Math.hypot(currentPullX, currentPullY);
        const shake = dist / 10;
        updateJar(currentPullX, currentPullY, shake);
        if (dist > 0.5 || Math.abs(velX) > 0.1) {
          requestAnimationFrame(animate);
        } else {
          currentPullX = currentPullY = velX = velY = 0;
          resetJar();
        }
      };
      animate();
    } else {
      updateJar(0, 0, 4);
      setTimeout(() => {
        if (!isDragging && !isSpringingBack) updateJar(0, 0, 0);
      }, 300);
    }
  };

  jar.addEventListener('pointerdown', e => {
    startInteraction(e.clientX, e.clientY);
    jar.setPointerCapture(e.pointerId);
  });
  jar.addEventListener('pointermove', e => {
    if (e.buttons > 0) moveInteraction(e.clientX, e.clientY);
  });
  jar.addEventListener('pointerup', endInteraction);
  jar.addEventListener('pointercancel', endInteraction);

  jar.addEventListener('touchstart', e => {
    e.preventDefault();
    const touch = e.touches[0];
    startInteraction(touch.clientX, touch.clientY);
  });
  jar.addEventListener('touchmove', e => {
    e.preventDefault();
    const touch = e.touches[0];
    moveInteraction(touch.clientX, touch.clientY);
  });
  jar.addEventListener('touchend', endInteraction);

  const idleLoop = () => {
    if (!isDragging && !isSpringingBack) updateJar(0, 0, 0);
    requestAnimationFrame(idleLoop);
  };
  idleLoop();

  updateJar(0, 0, 0);
  jar.style.animation = window.innerWidth >= 768 ? 'idleJarDesktop 16s infinite ease-in-out' : 'idleJarMobile 14s infinite ease-in-out';
}

window.addEventListener('load', () => jars.forEach(initJar));
window.addEventListener('resize', () => {
    jars.forEach(initJar);
    createStars();
});
</script>

</body>
</html>